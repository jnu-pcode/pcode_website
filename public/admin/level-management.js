// Ïñ¥ÎìúÎØº Î†àÎ≤® Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ JavaScript

class AdminLevelManager {
    constructor() {
        this.users = [];
        this.titleSettings = null;
        this.currentUser = null;
        this.init();
    }

    async init() {
        
        // Í∂åÌïú ÌôïÏù∏
        if (!await this.checkAdminPermission()) {
            alert('Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
            window.location.href = '/login';
            return;
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        this.setupEventListeners();
        
        // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        await this.loadAllData();
    }

    async checkAdminPermission() {
        try {
            const response = await fetch('/api/user/me', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                return data.user && data.user.is_admin;
            }
            return false;
        } catch (error) {
            console.error('Í∂åÌïú ÌôïÏù∏ Ïò§Î•ò:', error);
            return false;
        }
    }

    setupEventListeners() {
        // ÏÉàÎ°úÍ≥†Ïπ® Î≤ÑÌäº
        document.getElementById('refreshBtn').addEventListener('click', () => {
            this.loadAllData();
        });

        // ÏÇ¨Ïö©Ïûê Í≤ÄÏÉâ
        document.getElementById('userSearch').addEventListener('input', (e) => {
            this.filterUsers();
        });

        // Î†àÎ≤® ÌïÑÌÑ∞
        document.getElementById('levelFilter').addEventListener('change', (e) => {
            this.filterUsers();
        });

        // Ïπ≠Ìò∏ ÏÑ§Ï†ï Ï†ÄÏû•
        document.getElementById('saveTitlesBtn').addEventListener('click', () => {
            this.saveTitleSettings();
        });

        // Î™®Îã¨ Í¥ÄÎ†®
        document.getElementById('closeModal').addEventListener('click', () => {
            this.closeModal();
        });

        document.getElementById('userModal').addEventListener('click', (e) => {
            if (e.target.id === 'userModal') {
                this.closeModal();
            }
        });

        // Î™®Îã¨ ÎÇ¥ Î≤ÑÌäºÎì§
        document.getElementById('applyXPBtn').addEventListener('click', () => {
            this.adjustUserXP();
        });

        document.getElementById('grantTitleBtn').addEventListener('click', () => {
            this.grantSpecialTitle();
        });

        document.getElementById('removeTitleBtn').addEventListener('click', () => {
            this.removeSpecialTitle();
        });
    }

    async loadAllData() {
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.innerHTML = '<div class="loading"></div> Î°úÎî© Ï§ë...';
        refreshBtn.disabled = true;

        try {
            await Promise.all([
                this.loadDashboardStats(),
                this.loadUsers(),
                this.loadTitleSettings()
            ]);
        } catch (error) {
            console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
            alert('Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        } finally {
            refreshBtn.innerHTML = 'üîÑ ÏÉàÎ°úÍ≥†Ïπ®';
            refreshBtn.disabled = false;
        }
    }

    async loadDashboardStats() {
        try {
            const response = await fetch('/api/admin/dashboard/stats', {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                this.updateDashboard(data.stats);
            } else {
                throw new Error('ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
            }
        } catch (error) {
            console.error('ÎåÄÏãúÎ≥¥Îìú ÌÜµÍ≥Ñ Î°úÎìú Ïò§Î•ò:', error);
        }
    }

    updateDashboard(stats) {
        document.getElementById('totalUsers').textContent = stats.totalUsers.toLocaleString();
        document.getElementById('avgLevel').textContent = stats.avgLevel;
        document.getElementById('totalXP').textContent = stats.totalXP.toLocaleString();
        document.getElementById('activeToday').textContent = stats.activeToday;
    }

    async loadUsers() {
        try {
            const response = await fetch('/api/admin/users', {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                this.users = data.users;
                this.displayUsers(this.users);
            } else {
                throw new Error('ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
            }
        } catch (error) {
            console.error('ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
        }
    }

    displayUsers(users) {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';

        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <strong>${user.username}</strong>
                    ${user.is_admin ? '<span style="color: #e74c3c;">üëë</span>' : ''}
                    ${user.is_member ? '<span style="color: #f39c12;">‚≠ê</span>' : ''}
                </td>
                <td><strong>Lv.${user.level}</strong></td>
                <td>${user.experience.toLocaleString()} XP</td>
                <td>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${user.levelInfo.progressPercent}%"></div>
                    </div>
                    <small>${user.levelInfo.progressPercent}%</small>
                </td>
                <td><span class="title-badge">${user.title}</span></td>
                <td>
                    ${user.special_title ? 
                        `<span class="special-title-badge">${user.special_title}</span>` : 
                        '<span style="color: #999;">ÏóÜÏùå</span>'
                    }
                </td>
                <td>
                    <button class="btn-primary" onclick="adminManager.openUserModal(${user.id})">
                        Í¥ÄÎ¶¨
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    filterUsers() {
        const searchTerm = document.getElementById('userSearch').value.toLowerCase();
        const levelFilter = document.getElementById('levelFilter').value;

        let filteredUsers = this.users.filter(user => {
            const matchesSearch = user.username.toLowerCase().includes(searchTerm);
            
            let matchesLevel = true;
            if (levelFilter) {
                if (levelFilter === '5+') {
                    matchesLevel = user.level >= 5;
                } else {
                    matchesLevel = user.level == parseInt(levelFilter);
                }
            }

            return matchesSearch && matchesLevel;
        });

        this.displayUsers(filteredUsers);
    }

    async loadTitleSettings() {
        try {
            const response = await fetch('/api/admin/titles/settings', {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                this.titleSettings = data.titleSettings;
                this.displayTitleSettings();
            } else {
                throw new Error('Ïπ≠Ìò∏ ÏÑ§Ï†ï Î°úÎìú Ïã§Ìå®');
            }
        } catch (error) {
            console.error('Ïπ≠Ìò∏ ÏÑ§Ï†ï Î°úÎìú Ïò§Î•ò:', error);
        }
    }

    displayTitleSettings() {
        // Í∏∞Î≥∏ Ïπ≠Ìò∏ ÏÑ§Ï†ï ÌëúÏãú
        const basicTitlesGrid = document.getElementById('basicTitlesGrid');
        basicTitlesGrid.innerHTML = '';

        this.titleSettings.levelTitles.forEach((titleInfo, index) => {
            const titleItem = document.createElement('div');
            titleItem.className = 'title-item';
            titleItem.innerHTML = `
                <label>Î†àÎ≤® ${titleInfo.minLevel}+ Ïπ≠Ìò∏:</label>
                <input type="text" data-index="${index}" value="${titleInfo.title}" 
                       placeholder="Ïπ≠Ìò∏ ÏûÖÎ†•">
                <small>${titleInfo.description}</small>
            `;
            basicTitlesGrid.appendChild(titleItem);
        });

        // ÌäπÎ≥Ñ Ïπ≠Ìò∏ ÌëúÏãú
        const specialTitlesGrid = document.getElementById('specialTitlesGrid');
        specialTitlesGrid.innerHTML = '';

        this.titleSettings.specialTitles.forEach(titleInfo => {
            const titleItem = document.createElement('div');
            titleItem.className = 'title-item';
            titleItem.innerHTML = `
                <span class="special-title-badge">${titleInfo.title}</span>
                <p>${titleInfo.description}</p>
            `;
            specialTitlesGrid.appendChild(titleItem);
        });

        // ÌäπÎ≥Ñ Ïπ≠Ìò∏ ÏÑ†ÌÉù ÏòµÏÖò ÏóÖÎç∞Ïù¥Ìä∏
        this.updateSpecialTitleSelect();
    }

    updateSpecialTitleSelect() {
        const select = document.getElementById('specialTitleSelect');
        select.innerHTML = '<option value="">Ïπ≠Ìò∏ ÏÑ†ÌÉù</option>';

        this.titleSettings.specialTitles.forEach(titleInfo => {
            const option = document.createElement('option');
            option.value = titleInfo.title;
            option.textContent = `${titleInfo.title} - ${titleInfo.description}`;
            select.appendChild(option);
        });
    }

    async saveTitleSettings() {
        const inputs = document.querySelectorAll('#basicTitlesGrid input');
        const updatedLevelTitles = [...this.titleSettings.levelTitles];

        inputs.forEach(input => {
            const index = parseInt(input.dataset.index);
            updatedLevelTitles[index].title = input.value;
        });

        try {
            const response = await fetch('/api/admin/titles/settings', {
                method: 'PUT',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    levelTitles: updatedLevelTitles
                })
            });

            if (response.ok) {
                const data = await response.json();
                this.titleSettings = data.titleSettings;
                alert('Ïπ≠Ìò∏ ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
                
                // ÏÇ¨Ïö©Ïûê Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® (ÏÉà Ïπ≠Ìò∏ Î∞òÏòÅ)
                await this.loadUsers();
            } else {
                throw new Error('Ïπ≠Ìò∏ ÏÑ§Ï†ï Ï†ÄÏû• Ïã§Ìå®');
            }
        } catch (error) {
            console.error('Ïπ≠Ìò∏ ÏÑ§Ï†ï Ï†ÄÏû• Ïò§Î•ò:', error);
            alert('Ïπ≠Ìò∏ ÏÑ§Ï†ï Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
    }

    async openUserModal(userId) {
        this.currentUser = this.users.find(user => user.id === userId);
        if (!this.currentUser) return;

        // Î™®Îã¨ Ï†úÎ™© ÏÑ§Ï†ï
        document.getElementById('modalUserName').textContent = 
            `${this.currentUser.username} ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨`;

        // ÌòÑÏû¨ Í≤ΩÌóòÏπò ÏÑ§Ï†ï
        document.getElementById('currentXP').value = this.currentUser.experience;

        // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
        document.getElementById('xpAdjustment').value = '';
        document.getElementById('adjustmentReason').value = '';

        // Í≤ΩÌóòÏπò ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú
        await this.loadUserHistory(userId);

        // Î™®Îã¨ ÌëúÏãú
        document.getElementById('userModal').style.display = 'flex';
    }

    closeModal() {
        document.getElementById('userModal').style.display = 'none';
        this.currentUser = null;
    }

    async adjustUserXP() {
        if (!this.currentUser) return;

        const xpChange = parseInt(document.getElementById('xpAdjustment').value);
        const reason = document.getElementById('adjustmentReason').value;

        if (!xpChange || !reason) {
            alert('Í≤ΩÌóòÏπò Î≥ÄÌôîÎüâÍ≥º ÏÇ¨Ïú†Î•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            return;
        }

        try {
            const response = await fetch('/api/admin/users/adjust-xp', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: this.currentUser.id,
                    xpChange: xpChange,
                    reason: reason
                })
            });

            if (response.ok) {
                const data = await response.json();
                alert(`Í≤ΩÌóòÏπò Ï°∞Ï†ï ÏôÑÎ£å!\n${data.oldXP} ‚Üí ${data.newXP} XP${data.leveledUp ? `\nÎ†àÎ≤®ÏóÖ! ${data.oldLevel} ‚Üí ${data.newLevel}` : ''}`);
                
                // Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
                await this.loadUsers();
                await this.loadUserHistory(this.currentUser.id);
                
                // ÌòÑÏû¨ Í≤ΩÌóòÏπò ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('currentXP').value = data.newXP;
                document.getElementById('xpAdjustment').value = '';
                document.getElementById('adjustmentReason').value = '';
            } else {
                throw new Error('Í≤ΩÌóòÏπò Ï°∞Ï†ï Ïã§Ìå®');
            }
        } catch (error) {
            console.error('Í≤ΩÌóòÏπò Ï°∞Ï†ï Ïò§Î•ò:', error);
            alert('Í≤ΩÌóòÏπò Ï°∞Ï†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
    }

    async grantSpecialTitle() {
        if (!this.currentUser) return;

        const specialTitle = document.getElementById('specialTitleSelect').value;
        if (!specialTitle) {
            alert('Î∂ÄÏó¨Ìï† ÌäπÎ≥Ñ Ïπ≠Ìò∏Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
            return;
        }

        await this.manageSpecialTitle('grant', specialTitle);
    }

    async removeSpecialTitle() {
        if (!this.currentUser) return;

        if (!this.currentUser.special_title) {
            alert('Ï†úÍ±∞Ìï† ÌäπÎ≥Ñ Ïπ≠Ìò∏Í∞Ä ÏóÜÏäµÎãàÎã§.');
            return;
        }

        await this.manageSpecialTitle('remove');
    }

    async manageSpecialTitle(action, specialTitle = null) {
        try {
            const response = await fetch('/api/admin/users/special-title', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: this.currentUser.id,
                    action: action,
                    specialTitle: specialTitle
                })
            });

            if (response.ok) {
                const data = await response.json();
                alert(data.message);
                
                // Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
                await this.loadUsers();
                await this.loadUserHistory(this.currentUser.id);
            } else {
                throw new Error('ÌäπÎ≥Ñ Ïπ≠Ìò∏ Í¥ÄÎ¶¨ Ïã§Ìå®');
            }
        } catch (error) {
            console.error('ÌäπÎ≥Ñ Ïπ≠Ìò∏ Í¥ÄÎ¶¨ Ïò§Î•ò:', error);
            alert('ÌäπÎ≥Ñ Ïπ≠Ìò∏ Í¥ÄÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
    }

    async loadUserHistory(userId) {
        try {
            const response = await fetch(`/api/admin/users/${userId}/history?limit=10`, {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                this.displayUserHistory(data.history);
            } else {
                throw new Error('ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú Ïã§Ìå®');
            }
        } catch (error) {
            console.error('ÏÇ¨Ïö©Ïûê ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú Ïò§Î•ò:', error);
        }
    }

    displayUserHistory(history) {
        const historyContainer = document.getElementById('xpHistory');
        historyContainer.innerHTML = '';

        if (history.length === 0) {
            historyContainer.innerHTML = '<p style="color: #999;">ÌûàÏä§ÌÜ†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
            return;
        }

        history.forEach(item => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            const date = new Date(item.created_at).toLocaleString();
            const xpText = item.xp_gained > 0 ? `+${item.xp_gained}` : item.xp_gained;
            
            historyItem.innerHTML = `
                <div class="history-date">${date}</div>
                <div class="history-action">${xpText} XP - ${this.getActionTypeName(item.action_type)}</div>
                <div class="history-description">${item.description}</div>
            `;
            
            historyContainer.appendChild(historyItem);
        });
    }

    getActionTypeName(actionType) {
        const actionNames = {
            'wargame_solve': 'ÏõåÍ≤åÏûÑ Ìï¥Í≤∞',
            'admin_adjustment': 'Í¥ÄÎ¶¨Ïûê Ï°∞Ï†ï',
            'admin_title': 'ÌäπÎ≥Ñ Ïπ≠Ìò∏',
            'daily_login': 'ÏùºÏùº Î°úÍ∑∏Ïù∏',
            'first_solve': 'ÏµúÏ¥à Ìï¥Í≤∞',
            'knowledge_contribute': 'ÏßÄÏãù Í∏∞Ïó¨'
        };
        
        return actionNames[actionType] || actionType;
    }
}

// Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
let adminManager;

// DOM Î°úÎìú ÏôÑÎ£å Ïãú Ï¥àÍ∏∞Ìôî
document.addEventListener('DOMContentLoaded', () => {
    adminManager = new AdminLevelManager();
}); 